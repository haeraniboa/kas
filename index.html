<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kas Terintegrasi v2.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --green: #2ecc71; --red: #e74c3c; --dark: #2c3e50; --bg: #f4f7f6; --gray: #7f8c8d; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; min-height: 100vh; display: flex; flex-direction: column; }
        header { background: var(--dark); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1100px; margin: 25px auto; padding: 0 15px; flex: 1; }
        
        /* Stats Card */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card h4 { margin: 0; font-size: 13px; color: var(--gray); text-transform: uppercase; }
        .card .val { font-size: 26px; font-weight: 800; margin: 10px 0; }

        /* Admin Action Bar */
        #adminBar { display: none; background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--green); align-items: center; gap: 10px; flex-wrap: wrap; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        /* Log Layout */
        .log-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        @media (max-width: 768px) { .log-grid { grid-template-columns: 1fr; } }
        .log-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; background: #f8f9fa; padding: 12px; color: #666; }
        td { padding: 12px; border-top: 1px solid #eee; }

        /* Modal & Form */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(3px); }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; }
        input, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        .btn-green { background: var(--green); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-red { background: var(--red); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-green:hover { background: #27ae60; }

        /* Footer Copyright */
        footer { background: var(--dark); color: #bdc3c7; padding: 20px 0; text-align: center; font-size: 14px; margin-top: 40px; }
        .copyright { display: flex; flex-direction: column; gap: 5px; }
        .copyright b { color: white; letter-spacing: 1px; }
        .copyright span { color: var(--green); }

    </style>
</head>
<body>

<header>
    <div style="font-size: 20px; font-weight: bold;"><i class="fas fa-chart-pie"></i> FINANCIAL KAS</div>
    <button class="btn-green" onclick="login()"><i class="fas fa-user-shield"></i> LOGIN ADMIN</button>
</header>

<div class="container">
    <div class="stats">
        <div class="card"><h4>Pemasukan (Kas + Denda)</h4><div id="totalIn" class="val" style="color:var(--green)">Rp 0</div></div>
        <div class="card"><h4>Pengeluaran Umum</h4><div id="totalOut" class="val" style="color:var(--red)">Rp 0</div></div>
        <div class="card"><h4>Saldo Bersih</h4><div id="totalNet" class="val" style="color:var(--dark)">Rp 0</div></div>
    </div>

    <div id="adminBar">
        <strong style="color:var(--green)"><i class="fas fa-tools"></i> Admin Panel:</strong>
        <button class="btn-green" onclick="openLogModal('Denda')"><i class="fas fa-plus"></i> Catat Denda</button>
        <button class="btn-red" onclick="openLogModal('Keluar')"><i class="fas fa-minus"></i> Catat Pengeluaran</button>
        <button style="background:#eee; border:none; padding:10px; border-radius:8px; cursor:pointer;" onclick="location.reload()">Logout</button>
    </div>

    <div class="log-grid">
        <div class="log-card">
            <h3 style="color:var(--green); margin-top:0"><i class="fas fa-history"></i> 5 Denda Terbaru</h3>
            <table id="tblDenda"><thead><tr><th>No</th><th>Ket</th><th>Tgl</th><th>Harga</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="log-card">
            <h3 style="color:var(--red); margin-top:0"><i class="fas fa-history"></i> 5 Pengeluaran Terbaru</h3>
            <table id="tblKeluar"><thead><tr><th>No</th><th>Ket</th><th>Tgl</th><th>Harga</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div class="log-card">
        <h3><i class="fas fa-users"></i> Absensi Kas Anggota</h3>
        <table id="tblKas">
            <thead><tr><th>Nama Anggota</th><th>M1</th><th>M2</th><th>M3</th><th>M4</th><th>Total</th><th class="adm" style="display:none">Edit</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div class="modal" id="modalKas">
    <div class="modal-content">
        <h3 id="kasTitle">Edit Kas Anggota</h3>
        <label>Nominal Pembayaran (Rp)</label>
        <input type="number" id="basePrice" value="5000">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0;">
            <label><input type="checkbox" id="m1"> Minggu 1</label>
            <label><input type="checkbox" id="m2"> Minggu 2</label>
            <label><input type="checkbox" id="m3"> Minggu 3</label>
            <label><input type="checkbox" id="m4"> Minggu 4</label>
        </div>
        <button class="btn-green" style="width:100%" onclick="saveKas()">SIMPAN PERUBAHAN</button>
        <button onclick="closeModal()" style="width:100%; background:none; border:none; margin-top:10px; color:#888;">Batal</button>
    </div>
</div>

<div class="modal" id="modalLog">
    <div class="modal-content">
        <h3 id="logTitle">Tambah Catatan</h3>
        <input type="hidden" id="logType">
        <input type="text" id="logKet" placeholder="Keterangan (Contoh: Beli Sapu)">
        <input type="date" id="logTgl">
        <input type="number" id="logHarga" placeholder="Nominal Rp">
        <button class="btn-green" id="logSubmitBtn" style="width:100%" onclick="saveLog()">TAMBAH DATA</button>
        <button onclick="closeModal()" style="width:100%; background:none; border:none; margin-top:10px; color:#888;">Batal</button>
    </div>
</div>

<footer>
    <div class="container">
        <div class="copyright">
            <b>&copy; 2026 SISTEM KAS PORTER</b>
            <div>Developed with <i class="fas fa-heart" style="color:var(--red)"></i> by <span>Hilman Boa</span></div>
            <div style="font-size: 11px; margin-top: 5px; opacity: 0.6;">Versi 2.0 | Semua Hak Dilindungi</div>
        </div>
    </div>
</footer>

<script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbyip828n-MsiUtkGplSg6mDV7Qxi_xM5z2rwWfUM9SvLA6l5weV3iXL56Hm47fK57Mr/exec"; 
    let db = {}; let isAdmin = false; let currentIdx = null;

    async function load() {
        const r = await fetch(APP_URL);
        db = await r.json();
        render();
    }

    function render() {
        const dBody = document.querySelector("#tblDenda tbody");
        const kBody = document.querySelector("#tblKeluar tbody");
        dBody.innerHTML = ""; kBody.innerHTML = "";
        
        let inTotal = 0, outTotal = 0, kasTotal = 0;

        db.logs.forEach(x => {
            if(x.Tipe === 'Denda') inTotal += Number(x.Harga);
            if(x.Tipe === 'Keluar') outTotal += Number(x.Harga);
        });

        db.logs.filter(x => x.Tipe === 'Denda').slice(-5).reverse().forEach(x => {
            dBody.innerHTML += `<tr><td>${x.No}</td><td>${x.Keterangan}</td><td>${x.Tanggal.split('T')[0]}</td><td>${fmt(x.Harga)}</td></tr>`;
        });
        db.logs.filter(x => x.Tipe === 'Keluar').slice(-5).reverse().forEach(x => {
            kBody.innerHTML += `<tr><td>${x.No}</td><td>${x.Keterangan}</td><td>${x.Tanggal.split('T')[0]}</td><td>${fmt(x.Harga)}</td></tr>`;
        });

        const kasBody = document.querySelector("#tblKas tbody");
        kasBody.innerHTML = "";
        db.kas.forEach((x, i) => {
            kasTotal += Number(x.Total);
            kasBody.innerHTML += `<tr>
                <td style="font-weight:bold">${x.Nama}</td>
                <td>${x['Minggu 1']>0?'✅':'-'}</td><td>${x['Minggu 2']>0?'✅':'-'}</td>
                <td>${x['Minggu 3']>0?'✅':'-'}</td><td>${x['Minggu 4']>0?'✅':'-'}</td>
                <td style="color:var(--green); font-weight:bold">${fmt(x.Total)}</td>
                <td class="adm" style="display:${isAdmin?'table-cell':'none'}">
                    <button onclick="openKasModal(${i})" style="border:none; background:none; color:#f39c12; cursor:pointer;"><i class="fas fa-edit"></i></button>
                </td>
            </tr>`;
        });

        document.getElementById('totalIn').innerText = "Rp " + fmt(kasTotal + inTotal);
        document.getElementById('totalOut').innerText = "Rp " + fmt(outTotal);
        document.getElementById('totalNet').innerText = "Rp " + fmt((kasTotal + inTotal) - outTotal);
    }

    function login() {
        if(prompt("Password Admin:") === "anbu123") {
            isAdmin = true;
            document.getElementById('adminBar').style.display = 'flex';
            document.querySelectorAll('.adm').forEach(e => e.style.display = 'table-cell');
            render();
        }
    }

    function openKasModal(i) {
        currentIdx = i; const d = db.kas[i];
        document.getElementById('kasTitle').innerText = d.Nama;
        document.getElementById('m1').checked = d['Minggu 1'] > 0;
        document.getElementById('m2').checked = d['Minggu 2'] > 0;
        document.getElementById('m3').checked = d['Minggu 3'] > 0;
        document.getElementById('m4').checked = d['Minggu 4'] > 0;
        document.getElementById('modalKas').style.display = 'flex';
    }

    function openLogModal(type) {
        document.getElementById('logType').value = type;
        document.getElementById('logTitle').innerText = "Input " + type;
        document.getElementById('modalLog').style.display = 'flex';
    }

    async function saveKas() {
        const p = document.getElementById('basePrice').value;
        const data = {
            action: 'editKas',
            rowIndex: db.kas[currentIdx].rowIndex,
            nama: db.kas[currentIdx].Nama,
            m1: document.getElementById('m1').checked ? p : 0,
            m2: document.getElementById('m2').checked ? p : 0,
            m3: document.getElementById('m3').checked ? p : 0,
            m4: document.getElementById('m4').checked ? p : 0
        };
        await postData(data);
    }

    async function saveLog() {
        const data = {
            action: 'addLog',
            tipe: document.getElementById('logType').value,
            keterangan: document.getElementById('logKet').value,
            tanggal: document.getElementById('logTgl').value,
            harga: document.getElementById('logHarga').value
        };
        await postData(data);
    }

    async function postData(d) {
        document.body.style.opacity = "0.5";
        await fetch(APP_URL, { method: 'POST', body: JSON.stringify(d) });
        location.reload();
    }

    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
    function fmt(n) { return Number(n).toLocaleString('id-ID'); }
    load();
</script>
</body>
</html>