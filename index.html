<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kas Pro - Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --green: #27ae60; --red: #e74c3c; --dark: #2c3e50; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        header { background: var(--dark); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 22px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
        
        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; }
        .card h4 { margin: 0; color: #7f8c8d; font-size: 14px; text-transform: uppercase; }
        .card .val { font-size: 24px; font-weight: bold; margin-top: 10px; }

        /* Main Table */
        .section-title { margin: 30px 0 15px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--dark); padding-left: 15px; }
        .main-card { background: white; border-radius: 12px; padding: 10px; overflow-x: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 15px; background: #fdfdfd; color: #444; font-size: 13px; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; }

        /* Inputs */
        .check-kas { width: 20px; height: 20px; cursor: pointer; accent-color: var(--green); }
        .btn { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-del { background: none; color: var(--red); border: 1px solid var(--red); padding: 5px 8px; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .btn-del:hover { background: var(--red); color: white; }

        /* Riwayat Grid */
        .grid-logs { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        @media (max-width: 768px) { .grid-logs { grid-template-columns: 1fr; } }

        /* Sync Notification */
        #syncNotif { position: fixed; bottom: 20px; right: 20px; background: var(--dark); color: white; padding: 10px 20px; border-radius: 50px; display: none; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(3px); }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

<header><i class="fas fa-database"></i> KAS PORTER BANJAR</header>

<div class="container">
    <div class="stats">
        <div class="card"><h4>Saldo Bersih</h4><div id="netSum" class="val" style="color:var(--dark)">Rp 0</div></div>
        <div class="card"><h4>Pemasukan</h4><div id="inSum" class="val" style="color:var(--green)">Rp 0</div></div>
        <div class="card"><h4>Pengeluaran</h4><div id="outSum" class="val" style="color:var(--red)">Rp 0</div></div>
    </div>

    <div style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
        <button class="btn" style="background:var(--green)" onclick="openModal('Denda')"><i class="fas fa-plus-circle"></i> Catat Denda Umum</button>
        <button class="btn" style="background:var(--red)" onclick="openModal('Keluar')"><i class="fas fa-minus-circle"></i> Catat Pengeluaran</button>
        <div style="flex:1"></div>
        <div style="background:white; padding:5px 15px; border-radius:8px; border:1px solid #ddd;">
            <small>Set Nominal:</small> <input type="number" id="baseNom" value="5000" style="width:80px; margin:0; border:none; font-weight:bold;">
        </div>
    </div>

    <div class="section-title"><h3><i class="fas fa-user-check"></i> Absensi Kas Anggota</h3></div>
    <div class="main-card">
        <table id="tblKas">
            <thead>
                <tr>
                    <th>NAMA ANGGOTA</th>
                    <th>M1</th><th>M2</th><th>M3</th><th>M4</th>
                    <th>TOTAL</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="grid-logs">
        <div class="main-card">
            <h4 style="color:var(--green); padding:10px;"><i class="fas fa-history"></i> Riwayat Denda</h4>
            <table id="riwayatDenda">
                <thead><tr><th>Ket</th><th>Harga</th><th>Hapus</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="main-card">
            <h4 style="color:var(--red); padding:10px;"><i class="fas fa-history"></i> Riwayat Pengeluaran</h4>
            <table id="riwayatKeluar">
                <thead><tr><th>Ket</th><th>Harga</th><th>Hapus</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal" id="modalLog">
    <div class="modal-content">
        <h3 id="logTitle">Input Data</h3>
        <input type="text" id="logKet" placeholder="Contoh: Telat / Beli Peralatan">
        <input type="date" id="logTgl">
        <input type="number" id="logHarga" placeholder="Nominal (Tanpa Titik)">
        <button class="btn" style="background:var(--green); width:100%" onclick="saveLog()">SIMPAN DATA</button>
        <button onclick="closeM()" style="width:100%; background:none; border:none; margin-top:15px; color:#888; cursor:pointer;">Batal</button>
    </div>
</div>

<div id="syncNotif"><i class="fas fa-cloud-upload-alt"></i> Menyimpan...</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbyip828n-MsiUtkGplSg6mDV7Qxi_xM5z2rwWfUM9SvLA6l5weV3iXL56Hm47fK57Mr/exec";
    let db = { kas: [], logs: [] };
    let activeType = "";

    async function load() {
        try {
            const r = await fetch(API);
            db = await r.json();
            render();
        } catch (e) { alert("Gagal memuat data!"); }
    }

    function render() {
        // Render Kas Anggota
        const bodyKas = document.querySelector("#tblKas tbody");
        bodyKas.innerHTML = "";
        let sumKas = 0, sumDenda = 0, sumKeluar = 0;

        db.kas.forEach((x, i) => {
            sumKas += Number(x.Total);
            bodyKas.innerHTML += `<tr>
                <td style="font-weight:bold">${x.Nama}</td>
                <td><input type="checkbox" class="check-kas" ${x['Minggu 1']>0?'checked':''} onchange="updateKas(${i}, 1, this)"></td>
                <td><input type="checkbox" class="check-kas" ${x['Minggu 2']>0?'checked':''} onchange="updateKas(${i}, 2, this)"></td>
                <td><input type="checkbox" class="check-kas" ${x['Minggu 3']>0?'checked':''} onchange="updateKas(${i}, 3, this)"></td>
                <td><input type="checkbox" class="check-kas" ${x['Minggu 4']>0?'checked':''} onchange="updateKas(${i}, 4, this)"></td>
                <td id="total-${i}" style="font-weight:bold; color:var(--green)">${fmt(x.Total)}</td>
            </tr>`;
        });

        // Render Riwayat Logs
        const bodyDenda = document.querySelector("#riwayatDenda tbody");
        const bodyKeluar = document.querySelector("#riwayatKeluar tbody");
        bodyDenda.innerHTML = ""; bodyKeluar.innerHTML = "";

        db.logs.forEach(x => {
            const row = `<tr>
                <td><small>${x.Tanggal.split('T')[0]}</small><br>${x.Keterangan}</td>
                <td>${fmt(x.Harga)}</td>
                <td><button class="btn-del" onclick="deleteLog('${x.rowIndex}', '${x.No}')"><i class="fas fa-trash"></i></button></td>
            </tr>`;
            
            if(x.Tipe === 'Denda') {
                sumDenda += Number(x.Harga);
                bodyDenda.innerHTML += row;
            } else {
                sumKeluar += Number(x.Harga);
                bodyKeluar.innerHTML += row;
            }
        });

        // Update Stats
        document.getElementById('inSum').innerText = "Rp " + fmt(sumKas + sumDenda);
        document.getElementById('outSum').innerText = "Rp " + fmt(sumKeluar);
        document.getElementById('netSum').innerText = "Rp " + fmt((sumKas + sumDenda) - sumKeluar);
    }

    // UPDATE KAS LANGSUNG (RESPONSIF)
    async function updateKas(idx, m, el) {
        const nom = Number(document.getElementById('baseNom').value);
        const item = db.kas[idx];
        item["Minggu " + m] = el.checked ? nom : 0;
        item.Total = Number(item['Minggu 1']) + Number(item['Minggu 2']) + Number(item['Minggu 3']) + Number(item['Minggu 4']);
        
        document.getElementById(`total-${idx}`).innerText = fmt(item.Total);
        updateDashboard(); // Update angka saldo instan

        toggleSync(true);
        const payload = {
            action: 'quickUpdate',
            rowIndex: item.rowIndex,
            nama: item.Nama,
            m1: item['Minggu 1'], m2: item['Minggu 2'], m3: item['Minggu 3'], m4: item['Minggu 4']
        };
        await fetch(API, { method: 'POST', body: JSON.stringify(payload) });
        toggleSync(false);
    }

    async function saveLog() {
        const payload = {
            action: 'addLog',
            tipe: activeType,
            keterangan: document.getElementById('logKet').value,
            tanggal: document.getElementById('logTgl').value,
            harga: document.getElementById('logHarga').value
        };
        toggleSync(true); closeM();
        await fetch(API, { method: 'POST', body: JSON.stringify(payload) });
        load(); // Reload full data
        toggleSync(false);
    }

    async function deleteLog(row, id) {
        if(!confirm("Hapus catatan ini?")) return;
        toggleSync(true);
        await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'deleteLog', id: id }) });
        load();
        toggleSync(false);
    }

    function updateDashboard() {
        let sumK = 0, sumD = 0, sumL = 0;
        db.kas.forEach(x => sumK += Number(x.Total));
        db.logs.forEach(x => { if(x.Tipe === 'Denda') sumD += Number(x.Harga); else sumL += Number(x.Harga); });
        document.getElementById('inSum').innerText = "Rp " + fmt(sumK + sumD);
        document.getElementById('netSum').innerText = "Rp " + fmt((sumK + sumD) - sumL);
    }

    function openModal(t) { activeType = t; document.getElementById('logTitle').innerText = "Input " + t; document.getElementById('modalLog').style.display = 'flex'; }
    function closeM() { document.getElementById('modalLog').style.display = 'none'; }
    function toggleSync(s) { document.getElementById('syncNotif').style.display = s ? 'block' : 'none'; }
    function fmt(n) { return Number(n).toLocaleString('id-ID'); }
    
    load();
</script>
</body>
</html>
